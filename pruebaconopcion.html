<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Consulta de Paciente</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="card shadow p-4">
            <h2 class="text-center mb-4">Buscar Informaci贸n del Paciente</h2>
            <form id="consultaForm">
                <div class="mb-3">
                    <label for="numero" class="form-label">ID del Paciente *</label>
                    <input type="text" class="form-control" id="numero" required>
                </div>
                <div class="mb-3">
                    <label for="columna" class="form-label">Columna a consultar (opcional)</label>
                    <input type="text" class="form-control" id="columna">
                </div>
                <button type="submit" class="btn btn-primary w-100">Buscar</button>
            </form>
        </div>
    </div>

    <!-- Modal para mostrar resultados -->
    <div class="modal fade" id="resultadoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Resultado de la Consulta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>ID Paciente:</strong> <span id="idPaciente"></span></p>
                    <div id="resultadoDetalle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script funcional -->
    <script>
        const form = document.getElementById("consultaForm");
        const idPacienteSpan = document.getElementById("idPaciente");
        const resultadoDetalle = document.getElementById("resultadoDetalle");

        form.addEventListener("submit", function(event) {
            event.preventDefault();

            const numero = document.getElementById("numero").value;
            const columna = document.getElementById("columna").value.trim().toUpperCase();
            const url = "https://735b-2803-c600-7115-9374-e90d-a17c-2fbf-c674.ngrok-free.app/mensaje";

            fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ mensaje: numero, columna: columna })
            })
            .then(response => {
                if (!response.ok) throw new Error("Error: " + response.status);
                return response.json();
            })
            .then(data => {
                idPacienteSpan.textContent = data.ID_paciente || numero;
                resultadoDetalle.innerHTML = "";

                if (data.datos) {
                    const clavesOrdenadas = Object.keys(data.datos).sort();
                    clavesOrdenadas.forEach(clave => {
                        if (clave === "EDAD") return; // evitamos mostrar EDAD sola
                        if (clave === "TIPO_EDAD") return; // la juntamos abajo
                    });

                    // Mostrar EDAD + TIPO_EDAD combinadas
                    const edad = data.datos["EDAD"];
                    const tipoEdad = data.datos["TIPO_EDAD"];
                    if (edad && tipoEdad) {
                        resultadoDetalle.innerHTML += `<p><strong>Edad:</strong> ${edad} ${tipoEdad.toLowerCase()}</p>`;
                    }

                    clavesOrdenadas.forEach(clave => {
                        if (clave !== "EDAD" && clave !== "TIPO_EDAD") {
                            resultadoDetalle.innerHTML += `<p><strong>${clave}:</strong> ${data.datos[clave]}</p>`;
                        }
                    });
                } else if (data.columna && data.valor) {
                    let valor = data.valor;
                    if (data.columna === "EDAD") {
                        resultadoDetalle.innerHTML = `<p><strong>Edad:</strong> ${valor}</p>`;
                    } else {
                        resultadoDetalle.innerHTML = `<p><strong>${data.columna}:</strong> ${valor}</p>`;
                    }
                } else if (data.error) {
                    resultadoDetalle.innerHTML = `<p class="text-danger"><strong>Error:</strong> ${data.error}</p>`;
                } else {
                    resultadoDetalle.innerHTML = `<p>No se encontr贸 informaci贸n.</p>`;
                }

                const modal = new bootstrap.Modal(document.getElementById("resultadoModal"));
                modal.show();
            })
            .catch(error => {
                idPacienteSpan.textContent = numero;
                resultadoDetalle.innerHTML = `<p class="text-danger"><strong>Error de conexi贸n:</strong> ${error.message}</p>`;
                const modal = new bootstrap.Modal(document.getElementById("resultadoModal"));
                modal.show();
            });
        });
    </script>
</body>
</html>
